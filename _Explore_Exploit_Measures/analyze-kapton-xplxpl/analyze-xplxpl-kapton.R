# We apply our explore explout statistics to the mbo run on the material design data.
# This script starts with the complete data that contains both numeric and integer variables.
# For infill optimization with cmaes, integer values have to be removed, 
# which is done in script "analyze-xplxpl-material-design-numeric.R"

library(mlr)
library(mlrMBO)
library(smoof)
library(emoa)
library(ggplot2)
library(gridExtra)

#source xplxplMBO-jr (and all dependencies)
source("_Explore_Exploit_Measures/xplxplMBO-jr.R")
# read data
source("_Explore_Exploit_Measures/analyze-kapton-xplxpl/read-data-kapton-jr.R")


set.seed(310320)

# initialize surrogate surrogate model

model = train(makeLearner("regr.randomForest"), makeRegrTask(data = data, target = "ratio"))

# Bayesian Optimization

fun = function(x) {
  df = as.data.frame(x)
  df$gas = factor(df$gas, levels = levels(data$gas))
  return(getPredictionResponse(predict(model, newdata = df)))
}

ps = makeParamSet(
  makeIntegerParam("power", lower = 10, upper = 5555),
  makeIntegerParam("time", lower = 500, upper = 20210),
  makeDiscreteParam("gas", values = c("Nitrogen", "Air", "Argon")),
  makeIntegerParam("pressure", lower = 0, upper = 1000)
)

objfun = makeSingleObjectiveFunction(
  name = "Kapton",
  fn = fun,
  par.set = ps,
  has.simple.signature = FALSE,
  minimize = FALSE
)

# sample 9 points for the initial surrogate model, stratified across gases
samples.argon = sample(rownames(data[data$gas == "Argon", ]), 4)
samples.nitro = sample(rownames(data[data$gas == "Nitrogen", ]), 3)
samples.air = sample(rownames(data[data$gas == "Air", ]), 3)
initial.data = data[c(samples.argon, samples.nitro, samples.air), ]
cat(paste("Best training ratio: ", max(initial.data$ratio), "\n", sep = ""))

iters = 3


ctrl = makeMBOControl(y.name = "ratio", propose.points = 1L, store.model.at = 1:(iters + 1))
ctrl = setMBOControlTermination(ctrl, iters = iters)

infill.crits = list(makeMBOInfillCritEI(),makeMBOInfillCritAdaCB(),
                    makeMBOInfillCritStandardError(), makeMBOInfillCritMeanResponse(),
                    makeMBOInfillCritAEI(), makeMBOInfillCritEQI(),
                    makeMBOInfillCritCB(cb.lambda = 0.1), 
                    makeMBOInfillCritCB(cb.lambda = 1),
                    makeMBOInfillCritCB(cb.lambda = 2),
                    makeMBOInfillCritCB(cb.lambda = 3),
                    makeMBOInfillCritCB(cb.lambda = 4),
                    makeMBOInfillCritCB(cb.lambda = 5),
                    makeMBOInfillCritCB(cb.lambda = 10),
                    makeMBOInfillCritCB(cb.lambda = 50),
                    makeMBOInfillCritCB(cb.lambda = 100),
                    makeMBOInfillCritCB(cb.lambda = 1000))

scope = c("local", "global")

# As material-design.csv contains mixed numeric/integer data, 
# only focus search and ea can be deployed in infill optimization

# store results here
path = paste(getwd(),"/_Explore_Exploit_Measures/results-kapton-xplxpl/", sep = "")

# set scope manually # woulde be nice to loop this as well, bur ggplot gets ugly then
scope = scope[1]
# only focussearch possible for kapton data, as cmaes and ea cannot handle cagtegorical data
infill.opt = "focussearch"

  for (i in seq_along(infill.crits)) {
    print(i)
    infill.criterion = infill.crits[[i]]
    ctrl = setMBOControlInfill(ctrl, opt = infill.opt, crit = infill.criterion)
    xpl.xpl = xplxplMBO(objfun, design = initial.data, control = ctrl, show.info = TRUE, scope = scope)
    
    lambda = infill.criterion$params$cb.lambda
    if (is.null(lambda)) {
      lambda = "NA"
    }
    
    save(xpl.xpl, file = paste(path, "xpl.xpl.", scope, ".", infill.opt, ".",
                               infill.criterion$id,".lambda=", lambda, ".RData", sep = ""))
    
    # store visualizations as .jpg
    jpeg(paste(path,"xpl.xpl.plot.", scope, ".", infill.opt, ".", infill.criterion$id,
               ".lambda=", lambda, ".jpg",sep = ""))
    
    
    grid.arrange(
      
      ggplot(data = xpl.xpl, aes(x = Iteration)) +
        geom_step(aes(y = Local.Standard.Error.Ratio), direction = "hv", color = "steelblue") +
        ylim(0,3)
      ,
      
      ggplot(data = xpl.xpl, aes(x = Iteration)) +
        geom_step(aes(y = Local.Standard.Error.Distribution.Value), direction = "hv", color = "darkred") +
        ylim(0,1)
      ,
      
      ggplot(data = xpl.xpl, aes(x = Iteration)) +
        geom_step(aes(y = Pairwise.Gower.Distance), direction = "hv", color = "magenta2") +
        ylim(0,1)
      ,
      
      ggplot(data = xpl.xpl, aes(x = Iteration)) +
        geom_step(aes(y = Mean.Gower.Distance), direction = "hv", color = "forestgreen") +
        ylim(0,1)
      ,
      
      ggplot(data = xpl.xpl, aes(x = Iteration)) +
        geom_step(aes(y = Minimal.Gower.Distance), direction = "hv", color = "deeppink3") +
        ylim(0,1)
      ,
      
      ggplot(data = xpl.xpl, aes(x = Iteration)) +
        geom_step(aes(y = Maximal.Gower.Distance), direction = "hv", color = "orange1") +
        ylim(0,1)
      ,
      
      ncol = 3
    )
    
    dev.off()
    
  }








