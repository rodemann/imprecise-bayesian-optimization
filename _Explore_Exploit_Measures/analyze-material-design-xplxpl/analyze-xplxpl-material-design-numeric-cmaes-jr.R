# We apply our explore explout statistics to the mbo run on the material design data.
# This script deals with numeric data only so that ea and cmaes can do the infill optimization 
library(mlr)
library(mlrMBO)
library(smoof)
library(emoa)
library(ggplot2)
library(gridExtra)

#source xplxplMBO-jr (and all dependencies)
source("_Explore_Exploit_Measures/xplxplMBO-jr.R")
# read data
source("_Explore_Exploit_Measures/analyze-material-design-xplxpl/read-data-material-design-jr.R")


set.seed(310320)

# kill integer parameters for cmaes:
data = data[,-(5:6)]

# initialize surrogate surrogate model
model = train(makeLearner("regr.randomForest"), makeRegrTask(data = data, target = "target"))


ps = makeParamSet(
  makeNumericParam("f", lower = 0, upper = 0.25),
  makeNumericParam("k", lower = 0, upper = 0.1),
  makeNumericParam("du", lower = 0, upper = 2e-5),
  makeNumericParam("dv", lower = 0, upper = 2e-5)
  # kill integer parameters for cmaes:
  #makeIntegerParam("x", lower = 0, upper = 200),
  #makeIntegerParam("y", lower = 0, upper = 200)
)

fun = function(x) {
  df = as.data.frame(x)
  return(getPredictionResponse(predict(model, newdata = df)))
}

objfun = makeSingleObjectiveFunction(
  name = "Synthesis",
  fn = fun,
  par.set = ps,
  has.simple.signature = FALSE,
  minimize = FALSE
)

infill.opt = "cmaes"

initial.data = generateDesign(20, attributes(objfun)$par.set) #from par space
iters = 30
ctrl = makeMBOControl(y.name = "target", propose.points = 1L, store.model.at = 1:(iters + 1))
ctrl = setMBOControlTermination(ctrl, iters = iters)

infill.crits = list(makeMBOInfillCritEI(),makeMBOInfillCritAdaCB(),
                    makeMBOInfillCritStandardError(), makeMBOInfillCritMeanResponse(),
                    makeMBOInfillCritAEI(), makeMBOInfillCritEQI(),
                    makeMBOInfillCritCB(cb.lambda = 0.1), 
                    makeMBOInfillCritCB(cb.lambda = 1),
                    makeMBOInfillCritCB(cb.lambda = 2),
                    makeMBOInfillCritCB(cb.lambda = 3),
                    makeMBOInfillCritCB(cb.lambda = 4),
                    makeMBOInfillCritCB(cb.lambda = 5),
                    makeMBOInfillCritCB(cb.lambda = 10),
                    makeMBOInfillCritCB(cb.lambda = 50),
                    makeMBOInfillCritCB(cb.lambda = 100),
                    makeMBOInfillCritCB(cb.lambda = 1000))

infill.opt = "cmaes"
scope = c("local", "global")

# As material-design.csv contains mixed numeric/integer data, 
# only focus search and ea can be deployed in infill optimization

# store results here
path = paste(getwd(),"/2_acquisition_function/2.3_Explore_Exploit_Ratio/results-material-design-numeric-cmaes-xplxpl/", sep = "")

# set scope manually # woulde be nice to loop this as well, bur ggplot gets ugly then #why again? Because measures are named local/global... internally
scope = "local"


  for (i in 6:16) {
    print(i)
    infill.criterion = infill.crits[[i]]
    ctrl = setMBOControlInfill(ctrl, opt = infill.opt, crit = infill.criterion)
    xpl.xpl = xplxplMBO(objfun, design = initial.data, control = ctrl, show.info = TRUE, scope = scope)
    
    lambda = infill.criterion$params$cb.lambda
    if (is.null(lambda)) {
      lambda = "NA"
    }
    
    save(xpl.xpl, file = paste(path, "xpl.xpl.", scope, ".", infill.opt, ".",
                               infill.criterion$id,".lambda=", lambda, ".RData", sep = ""))
    
    # store visualizations as .jpg
    jpeg(paste(path,"xpl.xpl.plot.", scope, ".", infill.opt, ".", infill.criterion$id,
               ".lambda=", lambda, ".jpg",sep = ""))
    
    
    grid.arrange(
      
      ggplot(data = xpl.xpl, aes(x = Iteration)) +
        geom_step(aes(y = Local.Standard.Error.Ratio), direction = "hv", color = "steelblue")
      ,
      
      ggplot(data = xpl.xpl, aes(x = Iteration)) +
        geom_step(aes(y = Local.Standard.Error.Distribution.Value), direction = "hv", color = "darkred")
      ,
      
      ggplot(data = xpl.xpl, aes(x = Iteration)) +
        geom_step(aes(y = Pairwise.Euclidean.Distance), direction = "hv", color = "magenta2")
      ,
      
      ggplot(data = xpl.xpl, aes(x = Iteration)) +
        geom_step(aes(y = Mean.Euclidean.Distance), direction = "hv", color = "forestgreen")
      ,
      
      ggplot(data = xpl.xpl, aes(x = Iteration)) +
        geom_step(aes(y = Minimal.Euclidean.Distance), direction = "hv", color = "deeppink3")
      ,
      
      ggplot(data = xpl.xpl, aes(x = Iteration)) +
        geom_step(aes(y = Maximal.Euclidean.Distance), direction = "hv", color = "orange1")
      ,
      
      ncol = 3
    )
    
    dev.off()
    
  }





